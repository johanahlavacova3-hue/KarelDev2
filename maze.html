<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Karel The Robot 25' maze</title>
<link rel="stylesheet" href="style.css">
<style>
  .home-btn {
    position: absolute;
    top: -60px;
    left: 10px;
    width: 40px;
    height: 40px;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    z-index: 100;
    transition: transform 0.2s ease-in-out;
  }
  .home-btn:hover { transform: scale(1.1); }
  .home-btn img {
    width: 100%;
    height: auto;
    display: block;
    image-rendering: pixelated;
  }
  .sidebar { position: relative; }

  .wall {
    background-image: url('Wall.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
  }

  .won {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 250px;
    height: auto;
    z-index: 200;
    display: none;
    animation: blink 0.4s infinite alternate;
  }

  @keyframes blink {
    from { content: url('WON-bright.png'); opacity: 1; }
    to   { content: url('WON-dark.png'); opacity: 0.7; }
  }
</style>
</head>
<body>

<div class="sidebar">
  <a href="index.html" class="home-btn">
    <img src="Home.png" alt="Home">
  </a>

  <textarea id="editor" placeholder="Napiš svůj kód...
například:
move();
turnLeft();
pickBeeper();"></textarea>
  <button id="runBtn"></button>
</div>

<div id="grid"></div>
<img id="wonImage" class="won" src="WON-bright.png" alt="WON">

<script>
// --------------------------------------
// Herní mřížka
// --------------------------------------
const grid = document.getElementById('grid');
const GRID_COLS = 7;
const GRID_ROWS = 4;

// Level data
const levels = [
  {
    start: [0, 3],
    walls: [[2, 3], [3, 3], [3, 2]],
    beepers: [[5, 0], [6, 2], [1, 1]]
  },
  {
    start: [0, 2],
    walls: [[1, 2], [1, 1], [4, 3], [5, 3], [5, 2]],
    beepers: [[6, 0], [3, 1], [2, 3]]
  },
  {
    start: [0, 3],
    walls: [[1, 3], [2, 3], [3, 2], [4, 1], [5, 1], [6, 1]],
    beepers: [[6, 3], [5, 0], [2, 0]]
  }
];

let currentLevel = 0;

// --------------------------------------
// Tvorba mřížky a reset
// --------------------------------------
function createGrid() {
  grid.innerHTML = '';
  grid.style.gridTemplateColumns = `repeat(${GRID_COLS}, 1fr)`;
  grid.style.gridTemplateRows = `repeat(${GRID_ROWS}, 1fr)`;
  for (let i = 0; i < GRID_COLS * GRID_ROWS; i++) {
    const cell = document.createElement('div');
    cell.className = 'cell';
    grid.appendChild(cell);
  }
}

function getCell(x, y) {
  return grid.children[y * GRID_COLS + x];
}

function setupLevel(levelIndex) {
  createGrid();
  const level = levels[levelIndex];
  posX = level.start[0];
  posY = level.start[1];
  dir = 'right';
  updateRobotRotation();

  // Kameny
  level.walls.forEach(([x, y]) => {
    getCell(x, y).classList.add('wall');
  });

  // Beepery
  level.beepers.forEach(([x, y]) => {
    const b = document.createElement('div');
    b.className = 'beeper';
    getCell(x, y).appendChild(b);
  });

  getCell(posX, posY).appendChild(robot);
}

createGrid();

// --------------------------------------
// Robot
// --------------------------------------
const robot = document.createElement('div');
robot.id = 'robot';
grid.appendChild(robot);

let posX = 0, posY = GRID_ROWS - 1, dir = 'right';
setupLevel(currentLevel);

function updateRobotRotation() {
  let angle = 0;
  if (dir === 'up') angle = -90;
  if (dir === 'down') angle = 90;
  if (dir === 'left') angle = 180;
  robot.style.transform = `rotate(${angle}deg)`;
}

// --------------------------------------
// Pohyb
// --------------------------------------
function isWall(x, y) {
  return getCell(x, y).classList.contains('wall');
}

function move() {
  let dx = 0, dy = 0;
  if (dir === 'right') dx = 1;
  if (dir === 'left') dx = -1;
  if (dir === 'up') dy = -1;
  if (dir === 'down') dy = 1;
  const newX = posX + dx, newY = posY + dy;

  if (newX < 0 || newX >= GRID_COLS || newY < 0 || newY >= GRID_ROWS) return;
  if (isWall(newX, newY)) return;

  getCell(posX, posY).removeChild(robot);
  posX = newX; posY = newY;
  getCell(posX, posY).appendChild(robot);
}

// --------------------------------------
// Ostatní příkazy
// --------------------------------------
function turnLeft() {
  if (dir === 'up') dir = 'left';
  else if (dir === 'left') dir = 'down';
  else if (dir === 'down') dir = 'right';
  else if (dir === 'right') dir = 'up';
  updateRobotRotation();
}

function turnRight() {
  if (dir === 'up') dir = 'right';
  else if (dir === 'right') dir = 'down';
  else if (dir === 'down') dir = 'left';
  else if (dir === 'left') dir = 'up';
  updateRobotRotation();
}

function pickBeeper() {
  const cell = getCell(posX, posY);
  const b = cell.querySelector('.beeper');
  if (b) {
    b.remove();
    checkWin();
  }
}

// --------------------------------------
// Výhra
// --------------------------------------
function checkWin() {
  if (grid.querySelectorAll('.beeper').length === 0) {
    const wonImg = document.getElementById('wonImage');
    wonImg.style.display = 'block';
    setTimeout(() => {
      wonImg.style.display = 'none';
      nextLevel();
    }, 3000);
  }
}

function nextLevel() {
  currentLevel++;
  if (currentLevel >= levels.length) currentLevel = 0; // loop zpět na level 1
  setupLevel(currentLevel);
}

// --------------------------------------
// Spuštění kódu hráče
// --------------------------------------
function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

async function runUserCode() {
  setupLevel(currentLevel);
  const code = document.getElementById('editor').value;
  const lines = code.split('\n').filter(l => l.trim() !== '');
  for (let line of lines) {
    try {
      await delay(300);
      eval(line);
    } catch (err) {
      console.error(err);
    }
  }
}

document.getElementById('runBtn').addEventListener('click', runUserCode);
</script>

</body>
</html>
